<polymer-element name="twitter-tweets" attributes="query language">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      #container {
        width: 100%;
        height: 100%;
        overflow: auto;
        position: relative;
      }
      span.highlight {
        color: orange;
      }
      p {
        padding-right: .5em;
      }
    </style>
    <div id="container">
      <content></content>
      <template repeat="{{tweet in tweets}}">
        <p>
          <strong>{{tweet.user.screen_name}}:</strong>
          <template repeat="{{part in tweet.parts}}"><span class="{{ part.highlight ? 'highlight' : '' }}">{{part.text}}</span></template>
        </p>
      </template>
    </div>
  </template>
  <script defer src="../SmartComposition/xhrq.js"></script>
  <script>
    Polymer({
      isSmartComponent: true,
      publish: {
        count: { value: '4', reflect: true },
        language: { value: 'en', reflect: true },
        query: { reflect: true }
      },
      countChanged: function() {
        this.query && this.getTweets();
      },
      queryChanged: function() {
        this.getTweets();
      },
      languageChanged: function() {
        this.query && this.getTweets();
      },
      getTweets: function() {
        var _this = this;
        var re = new RegExp('(' + this.query + ')', 'ig');
        window.xhrq.get('https://api.twitter.com/1.1/search/tweets.json', function(tweets) {
          _this.tweets = tweets && tweets.statuses || [];
          _this.tweets.forEach(function(tweet) {
            tweet.parts = tweet.text.split(re).map(function(part) {
              return { text: part, highlight: part.toLowerCase() === _this.query.toLowerCase()};
            });
          });
        }, {
          q: this.query,
          lang: this.language || 'en',
          count: this.count || 4
        }, 'json');
      },
      created: function() {
        this._pubsub_subscribe('tweets', this.queryReceived);
      },
      queryReceived: function(message) {
        if (typeof message.data === 'string') this.query = message.data;
      }
    });
  </script>
</polymer-element>