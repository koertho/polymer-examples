<polymer-element name="translate-text" attributes="from to" from="de" to="en">
  <template></template>
  <script defer src="xhrq.js"></script>
  <script>
    Polymer({
      isSmartComponent: true,
      publish: {
        from: { value: "de", reflect: true },
        to:   { value: "en", reflect: true }
      },
      fromChanged: function(old) {
        this._pubsub_unsubscribe('text_' + old, this.textReceived);
        this._pubsub_subscribe('text_' + this.from, this.textReceived);
      },
      created: function() {
        this._pubsub_subscribe('text_' + this.from, this.textReceived);
        this.getToken();
      },
      getToken: function(skipCache, callback) {
        var _this = this;
        window.xhrq.post('https://datamarket.accesscontrol.windows.net/v2/OAuth2-13', function(data) {
          if (typeof data === 'object') {
            _this._accessToken = data.access_token;
            if (typeof callback === 'function') callback.call(_this);
          } else {
            if (!skipCache) _this.getToken(true);
          }
        }, {
          client_id: "chroomaplus",
          client_secret: "DFmEPSjKACNI6XQzYC11UTzXiBAeJHsDe8o7ztVb5Pc=",
          scope: "http://api.microsofttranslator.com",
          grant_type: "client_credentials"
        }, 'json', skipCache);
      },
      translateText: function(text, callback) {
        var _this = this;
        window.xhrq.get('http://api.microsofttranslator.com/V2/Ajax.svc/Translate?oncomplete=', function(data) {
          if (~data.indexOf('ArgumentException')) {
            _this._accessToken = null;
            _this.getToken(true, function() { _this.translateText(text, callback); });
            return;
          }
          callback.call(_this, data);
        }, {
          appId: 'Bearer ' + this._accessToken,
          from: this.from,
          to: this.to,
          text: text
        }, 'json');
      },
      textReceived: function(message) {
        if (typeof message.data !== 'string' || !this._accessToken) return;
        this.translateText(message.data, function(data) { this._pubsub_publish('text_' + this.to, data) });
      }
    });
  </script>
</polymer-element>