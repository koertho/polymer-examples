<polymer-element name="smart-video" attributes="width height" width="400" height="300">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      :host #gmap {
        width: 100%;
        height: 100%;
        overflow: auto;
        position: relative;
      }
    </style>
    <video id="video" controls crossorigin="anonymous"></video>
  </template>
  <script>
    Polymer({
      isSmartComponent: true,
      publish: {
        width:   { reflect: true },
        height:  { reflect: true }
      },
      widthChanged: function() {
        this.style.width = this.width + "px";
      },
      heightChanged: function() {
        this.style.height = this.height + "px";
      },
      created: function() {
        this._pubsub_listening = false;
        this._ready = false;
        this._isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
        this._pubsub_subscribe('time', this.timeReceived);
      },
      attached: function() {
        this.initVideo();
      },
      initVideo: function() {
        var _this = this;

        this._video = this.$.video;
        if(!this._video || this.children.length === 0 || this._video.children.length > 0) return;

        for (var i = 0; i < this.children.length; i++) {
          if (this.children[i].nodeName === 'SOURCE' || this.children[i].nodeName === 'TRACK') {
            this._video.appendChild(document.importNode(this.children[i], true));
          }
        }

        this.activeCues = [];

        this.cueChanged = function() {
          var activeCues = this.activeCues;

          if (_this._skip) { _this.skip = false; return; }

          if (_this.IsFirefox) {
             if (activeCues.length === _this.activeCues.length) {
              if (activeCues.length === 0) return;
              var same = true;
              for (var index = 0; index < activeCues.length; index++) {
                if (_this.activeCues.indexOf(activeCues[index]) === -1) {
                  same = false;
                  break;
                }
              }
              if (same) return;
            }
            _this.activeCues = [];
          }

          for (var index = 0; index < activeCues.length; index++) {
            var cue = activeCues[index];
            var cueData = JSON.parse(cue.text);
            cueData.entries.forEach(function(entry) {
              var type = entry.type;
              var props = entry.properties;
              if (type === 'image' || type === 'wiki' || type === 'tweets' || type === 'coordinates') _this._pubsub_sendMessage(type, props.data);
              if (type === 'subtitle' && props.text_de) _this._pubsub_sendMessage('text_de', props.text_de);
              if (type === 'subtitle' && props.text_en) _this._pubsub_sendMessage('text_en', props.text_en);
            });
            if (_this._isFirefox) _this.activeCues.push(cue);
          }
        };

        this._video.addEventListener('loadedmetadata', function() {
          _this._ready = true;

          this.addEventListener('timeupdate', function() {
            _this._pubsub_sendMessage('time', this.currentTime);
            if (_this._isFirefox && textTrack) _this.cueChanged.bind(textTrack)();
          });

          if (_this.LastMessage && _this.LastMessage.data.type === 'time') {
            this.currentTime = parseInt(_this.LastMessage.data.data);
          }

          var textTrack = null, textTracks = this.textTracks;
          if (textTracks && textTracks.length > 0) {
            for (var index = 0; index < textTracks.length; index++) {
              if (textTracks[index].kind === 'metadata') {
                textTrack = textTracks[index];
                break;
              }
            }
          }
          if (!textTrack) return;
          textTrack.mode = 'hidden';
          if (!_this._isFirefox) textTrack.addEventListener('cuechange', _this.cueChanged);
        });
      },
      timeReceived: function(message) {
        if (parseInt(message.data) > 0 && this._ready) {
          this._video.currentTime = parseInt(message.data);
        }
      }
    });
  </script>
</polymer-element>